services:
  # Default service: CPU + keyword search (or API-based semantic search)
  # Usage: docker compose up
  #
  # Volume mapping:
  #   Mount the 1C platform installation directory that contains shcntx_ru.hbk.
  #   Replace the host path with your actual 1C platform path:
  #
  #   Linux:   /opt/1cv8/x86_64/8.3.25.1257
  #   Windows: /c/Program Files/1cv8/8.3.25.1257  (Docker Desktop path format)
  #            or use the short form: /c/Progra~1/1cv8/8.3.25.1257
  #
  mcp-bsl-context:
    build: .
    container_name: mcp-bsl-context
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      MCP_BSL_MODE: streamable-http
      MCP_BSL_HOST: "0.0.0.0"
      MCP_BSL_PORT: "8080"
      MCP_BSL_DATA_SOURCE: hbk
      MCP_BSL_PLATFORM_PATH: /data/platform
      # MCP_BSL_VERBOSE: "true"  # Uncomment for debug logging
    volumes:
      # Укажите путь к каталогу установки платформы 1С, содержащему shcntx_ru.hbk
      # Linux:
      #- /opt/1cv8/x86_64/8.3.25.1257:/data/platform:ro
      # Windows (Docker Desktop) — раскомментируйте нужную строку вместо Linux:
       - "C:/Program Files/1cv8/8.3.25.1257:/data/platform:ro"
      # YAML-конфиг (опционально):
      #- ./config.yml:/home/mcpuser/config.yml:ro
      # Персистентные данные (Qdrant + кэш моделей):
       - ./mcp-data/qdrant:/home/mcpuser/data/qdrant
       - ./mcp-data/models:/home/mcpuser/data/models
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('localhost', 8080), timeout=5); s.close()"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

  # GPU service: local sentence-transformers + torch with CUDA
  # Usage: docker compose --profile gpu up
  #
  # Requires:
  #   - NVIDIA GPU with drivers installed
  #   - nvidia-container-toolkit: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html
  #
  mcp-bsl-context-gpu:
    build:
      context: .
      dockerfile: Dockerfile.gpu
    container_name: mcp-bsl-context-gpu
    restart: unless-stopped
    profiles:
      - gpu
    ports:
      - "8080:8080"
    environment:
      MCP_BSL_MODE: streamable-http
      MCP_BSL_HOST: "0.0.0.0"
      MCP_BSL_PORT: "8080"
      MCP_BSL_DATA_SOURCE: hbk
      MCP_BSL_PLATFORM_PATH: /data/platform
      # MCP_BSL_VERBOSE: "true"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      # Linux:
      #- /opt/1cv8/x86_64/8.3.25.1257:/data/platform:ro
      # Windows (Docker Desktop):
       - "C:/Program Files/1cv8/8.3.25.1257:/data/platform:ro"
      # YAML-конфиг (опционально):
      #- ./config.yml:/home/mcpuser/config.yml:ro
      # Персистентные данные (Qdrant + кэш моделей) — сохраняются между перезапусками:
       - ./mcp-data/qdrant:/home/mcpuser/data/qdrant
       - ./mcp-data/models:/home/mcpuser/data/models
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.create_connection(('localhost', 8080), timeout=5); s.close()"]
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 3

  # Alternative: JSON data source
  # Usage: docker compose --profile json up
  # Place exported JSON files into ./json-data/
  mcp-bsl-context-json:
    build: .
    container_name: mcp-bsl-context-json
    restart: unless-stopped
    profiles:
      - json
    ports:
      - "8080:8080"
    environment:
      MCP_BSL_MODE: streamable-http
      MCP_BSL_HOST: "0.0.0.0"
      MCP_BSL_PORT: "8080"
      MCP_BSL_DATA_SOURCE: json
      MCP_BSL_PLATFORM_PATH: /data/platform
      MCP_BSL_JSON_PATH: /data/json
      # MCP_BSL_VERBOSE: "true"
    volumes:
      - ./json-data:/data/json:ro
      - ./mcp-data/qdrant:/home/mcpuser/data/qdrant
      - ./mcp-data/models:/home/mcpuser/data/models
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('localhost', 8080), timeout=5); s.close()"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
